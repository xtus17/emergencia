name: Cron Emergencia

on:
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      # 1. Recuperar el cachÃ© mÃ¡s reciente
      - name: Restore Cache
        id: restore-cache
        uses: actions/cache/restore@v3
        with:
          path: .emergencia_cache
          # Truco: Buscamos cualquier cachÃ© que empiece por este prefijo
          # pero definimos una key que no existe para forzar la bÃºsqueda en restore-keys
          key: cache-dynamic-${{ github.run_id }}
          restore-keys: |
            emergencia-v1-

      # 2. LÃ³gica de ComparaciÃ³n (Bash)
      - name: Fetch & Compare
        id: check
        run: |
          mkdir -p .emergencia_cache
          
          echo "========================================"
          echo "ðŸ”Ž ESTADO INICIAL DEL CACHÃ‰"
          echo "========================================"
          
          LAST_NUMERO=""
          if [ -f ".emergencia_cache/last_numero_parte.txt" ]; then
            echo "âœ… Archivo de cachÃ© encontrado (.emergencia_cache/last_numero_parte.txt)"
            LAST_NUMERO=$(cat .emergencia_cache/last_numero_parte.txt)
            echo "ðŸ“„ Contenido recuperado: [$LAST_NUMERO]"
          else
            echo "âŒ No se encontrÃ³ cachÃ© previo."
          fi
          echo "========================================"

          echo "ðŸ“¡ CONSULTANDO ENDPOINT..."
          RESPONSE=$(curl -s https://emergencia-blue.vercel.app/api/scrapper || echo "")
          
          echo "ðŸ“¥ RESPUESTA DEL SERVIDOR:"
          echo "$RESPONSE"
          echo "========================================"
          
          if [ -z "$RESPONSE" ] || [ "$RESPONSE" == "null" ]; then
             echo "âš ï¸ API vacÃ­a o error."
             echo "SHOULD_RUN=false" >> $GITHUB_ENV
             exit 0
          fi

          # VERIFICAR SI DATA ES NULL ANTES DE CONTINUAR
          IS_DATA_NULL=$(echo "$RESPONSE" | jq -r '.data == null')
          
          if [ "$IS_DATA_NULL" == "true" ]; then
             echo "ðŸ›‘ ALERTA: La API devolviÃ³ 'data: null'."
             echo "No hay emergencias activas o el scraper fallÃ³."
             echo "NO se actualizarÃ¡ el cachÃ© ni se enviarÃ¡n notificaciones."
             echo "SHOULD_RUN=false" >> $GITHUB_ENV
             exit 0
          fi

          # C. EXTRAER NUEVO NUMERO PARTE (Solo si data no es null)
          NEW_NUMERO=$(echo "$RESPONSE" | jq -r '.data[-1]' 2>/dev/null)

          echo "ðŸ”¢ NumeroParte extraÃ­do de API: [$NEW_NUMERO]"
          echo "ðŸ’¾ NumeroParte en CachÃ©:      [$LAST_NUMERO]"
          echo "========================================"

          if [ "$NEW_NUMERO" == "null" ] || [ -z "$NEW_NUMERO" ]; then
             echo "âš ï¸ No se pudo extraer numeroParte vÃ¡lido (valor vacÃ­o o null)."
             echo "SHOULD_RUN=false" >> $GITHUB_ENV
             exit 0
          fi

          if [ "$NEW_NUMERO" == "$LAST_NUMERO" ]; then
             echo "âœ… IGUALES. No hacemos nada."
             echo "SHOULD_RUN=false" >> $GITHUB_ENV
          else
             echo "ðŸš€ DIFERENTES. Â¡Nueva emergencia detectada!"
             echo "SHOULD_RUN=true" >> $GITHUB_ENV
             
             {
               echo 'EMERGENCIA_RESPONSE<<ENDJSON'
               echo "$RESPONSE"
               echo 'ENDJSON'
             } >> "$GITHUB_ENV"

             echo "$NEW_NUMERO" > .emergencia_cache/last_numero_parte.txt
             echo "ðŸ“ Nuevo valor escrito en cachÃ© local."
          fi

      # 3. Guardar NUEVO CachÃ© (SOLO SI CAMBIÃ“)
      # Al guardar con una key nueva (usando run_id), forzamos a GitHub a crear una nueva entrada.
      # Si son iguales, saltamos este paso y el cachÃ© viejo sigue siendo vÃ¡lido para la prÃ³xima.
      - name: Save Cache
        if: env.SHOULD_RUN == 'true'
        uses: actions/cache/save@v3
        with:
          path: .emergencia_cache
          key: emergencia-v1-${{ github.run_id }}

      # 4. Configurar Node.js (SOLO SI CAMBIÃ“)
      - name: Setup Node
        if: env.SHOULD_RUN == 'true'
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          
      # 5. Instalar y Ejecutar Script (SOLO SI CAMBIÃ“)
      - name: Install & Notify
        if: env.SHOULD_RUN == 'true'
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_CREDENTIALS }}
          EMERGENCIA_RESPONSE: ${{ env.EMERGENCIA_RESPONSE }}
        run: |
          echo "âš™ï¸ Instalando dependencias..."
          echo "$FIREBASE_SERVICE_ACCOUNT" > firebase-service-account.json
          npm install
          
          echo "ðŸš€ Ejecutando script de notificaciones..."
          node sendNotifications.js
